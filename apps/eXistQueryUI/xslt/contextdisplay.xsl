<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:an="http://www.akomantoso.org/1.0" xmlns:xs="http://www.w3.org/2001/XMLSchema" exclude-result-prefixes="xs an" version="2.0"><xsl:output method="html"/>
    <!-- global variable to capture matched speech node depth --><xsl:variable name="speech-node-depth"><xsl:value-of select="/context/position-in-parent"/></xsl:variable>
    <!-- global template --><xsl:template match="/"><div class="contextresults"><xsl:apply-templates/></div></xsl:template><xsl:template match="position-in-parent">
        <!-- do nothing--></xsl:template><xsl:template match="preceding"><xsl:apply-templates select="subdivision"/></xsl:template><xsl:template match="parent"><xsl:apply-templates select="subdivision" mode="parent"/></xsl:template><xsl:template match="following"><xsl:apply-templates select="subdivision"/></xsl:template><xsl:template match="subdivision"><xsl:apply-templates select="heading" mode="subdiv"/><xsl:apply-templates select="speech"/></xsl:template><xsl:template match="subdivision" mode="parent"><xsl:apply-templates select="heading" mode="subdiv"/><xsl:apply-templates select="speech" mode="parent"/></xsl:template><xsl:template match="subdivision" mode="normal"><xsl:apply-templates select="heading" mode="subdiv"/><xsl:apply-templates select="speech"/></xsl:template><xsl:template match="heading" mode="subdiv"><h2><xsl:value-of select="."/></h2></xsl:template><xsl:template match="speech"><div class="speech"><xsl:apply-templates select="from"/><xsl:apply-templates select="p"/></div></xsl:template><xsl:template match="question"><div class="question"><xsl:apply-templates/></div></xsl:template><xsl:template match="answer"><div class="answer"><xsl:apply-templates/></div></xsl:template><xsl:template match="speech" mode="parent">
        <!-- check if the contextual speech node is the current one ... if yes 
            use a different class for the speech --><xsl:variable name="currentPosition">speech[<xsl:value-of select="position()"/>]</xsl:variable><xsl:element name="div"><xsl:choose><xsl:when test="$currentPosition eq $speech-node-depth"><xsl:attribute name="class">speech highlight</xsl:attribute></xsl:when><xsl:otherwise><xsl:attribute name="class">speech parent</xsl:attribute></xsl:otherwise></xsl:choose><xsl:apply-templates select="from"/><xsl:apply-templates select="p"/></xsl:element></xsl:template><xsl:template match="p"><p><xsl:value-of select="."/></p></xsl:template><xsl:template name="from" match="from"><em>
                From: <xsl:value-of select="."/></em></xsl:template></xsl:stylesheet>